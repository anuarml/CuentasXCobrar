<script type="text/javascript">var url=document.location.toString(),movementId;url.match("#")&&$(".nav-tabs a[href=#"+url.split("#")[1]+"]").tab("show");$(".nav-tabs a").on("shown",function(a){window.location.hash=a.target.hash});$("#searchClient").on("click",function(a){$("#loading").show();window.location="{{ url('cxc/movimiento/buscar/cliente') }}"});$("#searchClientOffice").on("click",function(a){toolbar.saveMov("searchClientOffice")});$("#searchMovReference").on("click",function(a){toolbar.saveMov("searchMovReference")});$("#showClientBalance").on("click",function(a){toolbar.saveMov("showClientBalance")});$("#Mov").on("change",function(a){$("#hidden_mov").val(this.value);this.disabled=!0;verifyMov()});
@if($mov->status == 'SINAFECTAR' || $mov->status == '')
$(document).ready(function(){$("#documentsTable tbody").on("contextmenu",function(a){var b=$(a.target).closest("tr").attr("data-index");if("undefined"==typeof b)return!1;var c=$("#documentsTable").bootstrapTable("getData"),d;if(!c||!c.length||!(d=c[b]))return!1;showEditRowModal(d);a.preventDefault?a.preventDefault():a.returnValue=!1;return!1});$("#documentsTable").bootstrapTable("showColumn","actions")});
@endif
var applyOptions="";$("#newDocumentRow").on("click",function(){if($("#client_id").val()){var a=$("#confirmModalBody");a.empty();addApplySelect(a);addConsecutiveInput(a);$("#confirmModal").find(".btn-primary").click(function(){var a=$("#documentApply").val();$("#confirmModal").modal("hide");addDocumentRow(new CxcD({apply:a}))});$("#confirmModal").modal("show")}else toolbar.showAlertModal("Selecciona un cliente.")});var clientDiscount=parseInt('{{$clientDiscount}}')||0;var movStatus='{{$mov->status}}';function addDocumentRow(a,b){a=a||new CxcD;b=b||new CxcDocument;var c=aCxcD.indexOf(null),d;-1==c?(d=aCxcD.length,a.tableRowID=d,aCxcD.push(a),aCxcDocs.push(b)):(d=c,a.tableRowID=d,aCxcD[c]=a,aCxcDocs[c]=b);$("#documentsTable").bootstrapTable("insertRow",{index:d,row:{id:d,apply:a.apply,apply_id:a.apply_id,amount:a.amount,difference:b.difference(a.amount),difference_percent:b.diferencePercent(a.amount),concept:b.concept,reference:b.reference,pp_discount:a.p_p_discount,pp_suggest:b.pp_suggest,actions:"<div class='deleteDocument'><div class='glyphicon glyphicon-remove'></div></div>"}});(""==movStatus||"SINAFECTAR"==movStatus)&&clientDiscount&&b.pp_suggest&&$("#documentsTable").bootstrapTable("showColumn","pp_suggest");updateTotalAmount(0,a.amount+a.p_p_discount);return d}var actionEvents={"click .deleteDocument":function(a,b,c,d){a=c.id;aCxcD[a]&&updateTotalAmount(aCxcD[a].amount+aCxcD[a].p_p_discount,0);aCxcD[a]=null;aCxcDocs[a]=null;$("#documentsTable").bootstrapTable("removeByUniqueId",a)}};function addApplySelect(a,b){"undefined"==typeof b&&(b="");a.append('<label for="documentApply">Aplica</label><select class="form-control input-sm" id="documentApply">'+applyOptions+"</select>");$("#documentApply").val(b);$("#documentApply").change(function(){var a=$("#rowid").val();"undefined"!=typeof a&&clearRowInfo(a)})}function addConsecutiveInput(a,b){"undefined"==typeof b&&(b="");a.append('<label for="consecutive">Consecutivo</label><div class="input-group"><span class="input-group-btn"><button type="button" class="btn btn-default btn-sm" id="searchConsecutive"><span class="glyphicon glyphicon-search"></span></button></span><input type="text" class="form-control input-sm" id="consecutive" value="'+b+'" readonly></div>');$("#searchConsecutive").click(function(a){if(a=$("#documentApply").val()){var b=$("#rowid").val();"undefined"==typeof b?b=addDocumentRow(new CxcD({apply:a})):updateRowInfo();$("#confirmModal").modal("hide");$("#clickedRow").val(b);toolbar.saveMov("searchConsecutive")}else toolbar.showAlertModal("Selecciona un aplica.")})}function addAmountInput(a,b){"undefined"==typeof b&&(b="");a.append('<label for="documentAmount">Importe</label><div class="input-group"><span class="input-group-btn"><button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#calculatorModal" id="btnCalculator"><span class="fa fa-calculator"></span></button></span><input type="number" class="form-control input-sm" id="documentAmount" value="'+b+'"></div>');$("#btnCalculator").on("click",function(a){documentAmount=document.getElementById("documentAmount");input.innerHTML=documentAmount.value;docRow=$("#rowid").val()});$("#documentAmount").on("change",function(){var a=$("#rowid").val(),b=parseFloat($(this).val())||0,h=0;if(a=aCxcDocs[a])h=a.balance;b=(new Decimal(h)).minus(b).toNumber();$("#doc-difference").val(b.toFixed(2))})}function addDiscountInput(a,b){"undefined"==typeof b&&(b="");a.append('<label for="discountPPP">Descuento</label><input type="number" class="form-control input-sm" id="discountPPP" value="'+b+'">')}function addDifferenceInput(a,b){informationInput='<label for="doc-difference" class="control-label">Diferencia</label><div class="input-group"><div class="input-group-addon">$</div><input type="text" id="doc-difference" class="form-control input-sm" readonly value="'+b+'"></div>';a.append(informationInput)}function addInformationInput(a,b,c,d){informationInput='<label for="'+c+'" class="control-label">'+b+'</label><input type="text" id="'+c+'" class="form-control input-sm" readonly value="'+d+'">';a.append(informationInput)}function addHiddenInput(a,b,c){informationInput='<input type="hidden" id="'+b+'" value="'+c+'">';a.append(informationInput)}function showEditRowModal(a){$("#confirmModal").find(".btn-primary").html("Actualizar");$("#confirmModal").find(".btn-default").html("Cancelar");$("#confirmModal").find(".btn-primary").click(function(){updateRowInfo()});var b=$("#confirmModalBody");b.empty();b.append('<input type="hidden" id="rowid" value="'+a.id+'">');addApplySelect(b,a.apply);addConsecutiveInput(b,a.apply_id);addAmountInput(b,a.amount);addDifferenceInput(b,a.difference);(movStatus==''||movStatus=='SINAFECTAR')&&clientDiscount&&(addDiscountInput(b,a.pp_discount),addInformationInput(b,"Sugerencia","suggestPPP",a.pp_suggest));addInformationInput(b,"Concepto","doc-concept",a.concept);a.reference&&addInformationInput(b,"Referencia","doc-reference",a.reference);var c=0;aCxcDocs[a.id]&&aCxcDocs[a.id].balance&&(c=aCxcDocs[a.id].balance);addHiddenInput(b,"doc-balance",c);$("#confirmModal").modal("show")}function updateRowInfo(){var a=$("#rowid").val(),b=$("#documentApply").val(),c=$("#consecutive").val(),d=parseFloat($("#documentAmount").val())||0,h=parseFloat($("#discountPPP").val())||0,l=parseFloat($("#suggestPPP").val())||0,m=$("#doc-reference").val()||"",n=$("#doc-concept").val()||"",p=$("#doc-balance").val()||0,e=aCxcD[a],f=aCxcDocs[a],k=$("#documentsTable").bootstrapTable("getData"),g=null;if(k&&(g=k[a])){var k=f.difference(d),q=f.diferencePercent(d),r=e.amount,t=e.p_p_discount;e.amount=d;e.p_p_discount=h;e.apply=b;e.apply_id=c;f.balance=p;f.concept=n;f.reference=m;f.pp_suggest=l;console.log(e);$("#confirmModal").modal("hide");g.apply=b;g.apply_id=c;g.amount=d;g.pp_discount=h;g.difference=k;g.difference_percent=q;g.pp_suggest=l;g.reference=m;g.concept=n;console.log(g,aCxcD,aCxcDocs);$("#documentsTable").bootstrapTable("updateRow",{index:a,row:g});updateTotalAmount(r+t,e.amount+e.p_p_discount)}}function getDocNumber(a){a=$(a).closest("tr").attr("id");a=a.split("-");return a[1]}function updateRowDifference(a){var b=$(a).closest("tr"),c=getDocNumber(a);a=aCxcD[c];c=aCxcDocs[c];b.find(".difference").html(c.difference(a.amount));b.find(".differencePercentage").html(c.diferencePercent(a.amount))}function clearRowInfo(a){$("#consecutive").val("");$("#documentAmount").val(0);$("#discountPPP").val(0);$("#doc-difference").val(0);$("#doc-reference").val("");$("#doc-concept").val("");$("#suggestPPP").val(0)}function updateTotalAmount(a,b){var c=$("#totalAmount"),d=new Decimal(parseFloat(c.val())||0);b=new Decimal(parseFloat(b)||0);d=d.plus(b.minus(parseFloat(a)||0));c.val(d.toNumber().toFixed(2));c.change()}var numberOfCharges=1,charges=[null,null,null,null,null],paymentTypeList=[],nChangeAmount="{{$mov->change}}";$("#newChargeRow").on("click",function(){addChargeRow()});function addChargeRow(a){a=a||new Charge;var b=aCharges.indexOf(null),c;if(!(5<numberOfCharges)){-1==b?(c=aCharges.length+1,aCharges.push(a)):(c=b+1,aCharges[b]=a);for(var b="",d=1;d<paymentTypeList.length;d++)var h=paymentTypeList[d],b=b+('<option value="'+h.payment_type+'">'+h.payment_type+"</option>");
@if($mov->status == 'SINAFECTAR' || $mov->status == '')
$("#charges").append("<div class='form-group' id='charge-"+c+"'><div class='col-sm-4'><label for='amount"+c+"'>Importe</label><div class='input-group'><div class='input-group-addon'>$</div><input type='number' class='form-control input-sm' id='amount"+c+"' name='amount"+c+"' value='"+(a.amount.toFixed(2)||"0.00")+"' min='0' step='any'></div></div><div class='col-sm-4'><label for='charge_type"+c+"'>Forma Cobro</label><select id='charge_type"+c+"' name='charge_type"+c+"' class='form-control input-sm'>"+b+"</select></div><div class='col-sm-3'><label for='reference"+c+"'>Referencia</label><input type='text' class='form-control input-sm' id='reference"+c+"' name='reference"+c+"' value='"+(a.reference||"")+"'></div><div class='col-xs-2 col-xs-offset-4 col-sm-offset-0 col-sm-1 ' id='deleteCharge"+c+"'><br><span class='glyphicon glyphicon-remove' style='font-size:30px; text-align:center; display: block;'></span></div><hr></div>");
@else
$("#charges").append("<div class='form-group' id='charge-"+c+"'><div class='col-sm-4'><label for='amount"+c+"'>Importe</label><div class='input-group'><div class='input-group-addon'>$</div><input type='number' class='form-control input-sm' id='amount"+c+"' name='amount"+c+"' value='"+(a.amount.toFixed(2)||"0.00")+"' min='0' step='any' readonly></div></div><div class='col-sm-4'><label for='charge_type"+c+"'>Forma Cobro</label><input type='text' class='form-control input-sm' id='charge_type"+c+"' name='charge_type"+c+"' value='"+(a.payment_type||"")+"' readonly></div><div class='col-sm-3'><label for='reference"+c+"'>Referencia</label><input type='text' class='form-control input-sm' id='reference"+c+"' name='reference"+c+"' value='"+(a.reference||"")+"' readonly></div><hr></div>");
@endif
$("#charge_type"+c).val(a.payment_type||"");b=$("#amount"+c);b.change(function(){var a=$(this),b=$("#totalCharge"),c=parseFloat(b.val()),d=parseFloat(a.val()),e=0,f=getCharge(a);f&&(e=f.amount,0>d||isNaN(d)?a.val(e.toFixed(2)):(f.amount=d,a.val(d.toFixed(2)),c=calculateTotal(c,d,e),b.val(c.toFixed(2)),b.change(),f.payment_type&&1==paymentTypeListChangeAllowed[f.payment_type]&&(a=$("#totalChangeAllowed"),b=a.val(),b=calculateTotal(b,d,e),a.val(b.toFixed(2)),a.change())))});b.focus(function(){$(this).val("")});b.blur(function(){var a=$(this);if(""==a.val()){var b=getCharge(a);b&&a.val(b.amount.toFixed(2))}});$("#charge_type"+c).change(function(){var a=$(this),b=getCharge(a);if(b){var c=b.payment_type;b.payment_type=a.val();a=c&&1==paymentTypeListChangeAllowed[c];c=b.payment_type&&1==paymentTypeListChangeAllowed[b.payment_type];if(c!=a){var d=$("#totalChangeAllowed"),e=parseFloat(d.val())||0;c&&!a?e=calculateTotal(e,b.amount,0):!c&&a&&(e=calculateTotal(e,0,b.amount));d.val(e.toFixed(2));d.change()}}});$("#deleteCharge"+c).click(function(){var a=$(this),a=getChargeNumber(a),b=$("#amount"+(a+1));b.val(0);b.change();aCharges[a]=null;numberOfCharges--;$(this).parent("div").remove()});$("#reference"+c).change(function(){var a=$(this),b=getCharge(a);b&&(b.reference=a.val())});a.amount&&(c=$("#totalCharge"),b=parseFloat(c.val())||0,b=calculateTotal(b,a.amount,0),c.val(b.toFixed(2)));numberOfCharges++}}function getChargeNumber(a){a=$(a).attr("id");var b=-1;if(!a||1>a.length)return b;b=parseInt(a.charAt(a.length-1))||0;return b-1}function getCharge(a){a=getChargeNumber(a);var b=null;return aCharges&&(b=aCharges[a])?b:(console.error("No existe el cobro en memoria."),null)}function calculateTotal(a,b,c){a=new Decimal(parseFloat(a)||0);b=parseFloat(b)||0;c=parseFloat(c)||0;a=a.plus(b);a=a.minus(c);return a.toNumber()}function calcTaxes(a){var b;a=parseFloat(a)||0;a=new Decimal(a);b=a.div(1.16);a=a.minus(b).toNumber();$("#amount").val(b.toNumber().toFixed(2));$("#taxes").val(a.toFixed(2))}function moneyFormatter(a){return"$"+(parseFloat(a)||0).toFixed(2)};</script>